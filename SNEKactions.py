from os import system
from termcolor import colored
import SNEKart
import pty

global spacer, buns
spacer = "============================================================"
buns = "************************************************************"


def help_main(layer):
    print('\n')
    with open('./SNEK_Help/main.txt', 'r') as file:
        for line in file:
            print(line.rstrip())
    file.close()
    if layer == 'main':
        print(spacer)
        print('              MAIN MENU')
        print(spacer)
        # Menus
        print('SHELLS:                   Enter the SHELLS menu')
        print('RECON:                    Enter the RECON menu')
        print('TRANSFER:                 Enter the Transfer menu')
        print(buns,'\n')


def help_reverse(layer):
    with open('./SNEK_Help/reverse.txt', 'r') as file:
        for line in file:
            print(line.rstrip())   
    file.close()
    print(buns,'\n') 


# Variable management
#============================================================================
def write_vars(var,val):
    content = str(var)+':'+str(val)+'\n'

    with open ('./.vars.SNEK', 'r') as file:
        fileContents = file.readlines()
        duplicate = False

        file.seek(0)
        lineCount = 0

        for line in file:
            if line.split(':')[0] == str(var):
                changeLine = int(lineCount)
                duplicate = True
            lineCount += 1

        if duplicate:
            fileContents[int(changeLine)] = content
    file.close()

    if not duplicate:
        with open ('./.vars.SNEK', 'a') as file:
            file.write(content)
        file.close()
    else:
        with open ('./.vars.SNEK', 'w') as file:
            file.writelines(fileContents)
        file.close()


def get_var(var):
    value = None
    foundVar = False

    with open('./.vars.SNEK','r') as file:
        for line in file:
            if line.split(':')[0] == str(var):
                value = line.split(":")[1].rstrip()
                foundVar = True
    file.close()

    if not foundVar:
        print('ERROR:  ',str(var),' IS NOT SET')

    return value


def clean_up():
    system('rm ./.vars.SNEK')


def print_vars():
    print('\n')
    with open ('./.vars.SNEK', 'r') as file:
        for line in file:
            print(line.rstrip())
    file.close()
    print('\n')
#============================================================================


def exit_SNEK(isMain):
    if isMain:
        exit()
    else:
        return


def launch_listner():
    listnerType = get_var('listner')
    system(str(listnerType) + ' -lvnp ' + str(get_var('attackerPort')))


def base_actions(command, layer):

    if command[0] == '!':
        print('\n')
        system(command[1:])
        print('\n')
    elif command in ['art', 'ART']:
        SNEKart.main()
    elif command in ['snek', 'SNEK']:
        SNEKart.title()
    elif command in ['quit', 'QUIT', 'Q']:
        clean_up()
        exit()
    # Help menus
    elif command in ['help', 'HELP']:
        if layer == 'main':
            help_main('main')
        elif layer == 'shells_reverse':
            help_main(layer)
            help_reverse(layer)
        else:
            help_main(layer)
    # Target variables
    elif command[:7] in ['target ', 'TARGET ']: # The spaces are important to avoiding conflict with other "target" vars
        target = command[7:] 
        write_vars('target',str(target))
        print(command[:6],'set as:  ', target)
    elif command in ['os', 'OS']:
        os = input("Windows or Linux:  ")
        if os in ['Windows', 'windows', 'w']:
            write_vars('os', 'windows')
        elif os in ['Linux', 'linux', 'l']:
            write_vars('os','linux')
    elif command[:10] in ['targetPort', 'targetport', 'TARGETPORT']:
        targetPort = command[11:]
        write_vars('targetPort',targetPort)
        print(command[:10],'set as',targetPort)
    # Attacker variables
    elif command[:8] in ['attacker', 'ATTACKER']:
        attackerIP = command[9:]
        write_vars('attackerIP',attackerIP)
        print(command[:8],'set as:  ',attackerIP)
    elif command[:10] in ['attackport', 'ATTACKPORT','attackPort']:
        attackerPort = command[11:]
        write_vars('attackPort',attackerPort)
        print(command[:10],'set as:  ',attackerPort)
    # Variable commands
    elif command in ['dump', 'DUMP']:
        certain = input("Warning you are about to clear all user set variables. Do you wish to proceed?\n")
        if certain in ['y', 'Y', 'Yes','yes','YES']:
            clean_up()
            system('touch .vars.SNEK')
            print("USER SET VARIABLES HAVE BEEN CAST INTO THE ETHER")
        else:
            print("ABORTING DATA DUMP")
    elif command in ['vars','VARS']:
        print_vars()
    # Tools
    elif command in ['listner','Listner']:
        launch_listner()
    elif command in ['shell','SHELL']:
        print('\nEntering bash shell!')
        print(colored('ctrl+d to escape!','white', 'on_red'))
        pty.spawn('/bin/bash')
    # Debugging
    elif command == 'test':
        write_vars('attackerIP','192.168.0.21')
        write_vars('os','linux')
        write_vars('payloadVector','nc')
        write_vars('rShell', '/bin/bash')
        print_vars()